<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>FitNext &ndash; Register New Member</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’ª</text></svg>">

    <link href="styles/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body>
<div id="app">
    <!-- Navbar -->
    <nav class="navbar navbar-expand navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">ðŸ’ª FitNext</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Main</a></li>
                    <li class="nav-item"><a class="nav-link" href="sessions.html">Sessions</a></li>
                    <li class="nav-item"><a class="nav-link" href="bookings.html">Bookings</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-lg" v-cloak>
        <div class="card m-2 shadow">
            <h5 class="card-header">New Member Registration</h5>
            <div class="card-body">
                <form @submit.prevent="onSubmit">
                    <div class="mb-3">
                        <label for="inputName" class="form-label">Your Name:</label>
                        <input type="text" class="form-control" :class="{'is-invalid': user_data_val.name}" id="inputName" aria-describedby="inputNameHelp" v-model="user_data.name" required>
                        <div class="invalid-feedback">
                            {{user_data_val.name}}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="inputEmail" class="form-label">Email Address:</label>
                        <input type="email" class="form-control" :class="{'is-invalid': user_data_val.email}" id="inputEmail" aria-describedby="emailHelp" v-model="user_data.email" required>
                        <div class="invalid-feedback">
                            {{user_data_val.email}}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="inputPhone" class="form-label">Phone Number:</label>
                        <input type="tel" class="form-control" :class="{'is-invalid': user_data_val.phone}" id="inputPhone" aria-describedby="phoneHelp" v-model="user_data.phone" required>
                        <div class="invalid-feedback">
                            {{user_data_val.phone}}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="termsText" class="form-label">Terms and Conditions:</label>
                        <textarea class="form-control" id="termsText" rows="10" readonly>By attending classes and using the park or venue or facilities and equipment, you hereby acknowledge and agree on behalf of yourself that you have voluntarily chosen to participate in intense physical exercise. We rely on you carrying out your own health self-assessment prior to taking part in any class. You agree to assume full responsibility for any and all injuries or damage to your person or property, which are sustained or aggravated by you in relation to the use of equipment and/or park or venue facilities.</textarea>
                    </div>

                    <div class="mb-3 form-check">
                        <input class="form-check-input" :class="{'is-invalid': user_data_val.terms_agreed}" type="checkbox" id="termsAgreeCheck" v-model="user_data.terms_agreed" required>
                        <label class="form-check-label" for="termsAgreeCheck">I agree to the terms and conditions</label>
                        <div class="invalid-feedback">
                            {{user_data_val.terms_agreed}}
                        </div>
                    </div>

                    <button id="submitButton" type="submit" class="btn btn-primary" :disabled="!user_data_val.ready || !user_data.terms_agreed">Register User</button>
                    <div v-if="register_result">
                        <div v-if="register_result.is_existing_user" class="text-danger">An account already exists with this email address. Please <a :href="'login.html?email=' + encodeURIComponent(user_data.email)">login</a> instead.</p></div>
                        <div v-else :class="{'text-danger': register_result.is_error}">{{register_result.message}}</div>
                    </div>
                </form>
            </div> <!-- end card body -->
        </div> <!-- end card -->
    </div> <!-- end main content -->

</div> <!-- End App -->
<div class="sticky-bottom bg-body">
    <div class="container-lg my-3 px-3">
        <p>&copy; 2024 Neil Bartlett all rights reserved. FitNext v202.</p>
    </div>
</div>
</body>

<script src="js/utils.js"></script>
<script type="module">
    import { createApp, reactive, ref, watch } from './js/vue.esm-browser.js'

    const user_data = reactive({
        name: "",
        email: "",
        phone: "",
        terms_agreed: false,
    })
    const user_data_val = ref({
        name: null,
        email: null,
        phone: null,
        terms_agreed: null,
        ready: false
    })
    const register_result = ref(null)

    async function onSubmit() {
        register_result.value = {
            message: "Processing...",
            is_error: false,
            is_existing_user: false
        }
        fetch(SERVER_URL + "/register_user", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                name: user_data.name,
                email: user_data.email,
                phone: user_data.phone,
                reset_url: SERVER_URL + "/passwordreset.html"
            })
        }).then(res => {
            if (!res.ok) throw res
            register_result.value = {
                message: "Registration email sent!",
                is_error: false,
                is_existing_user: false
            }
            window.location.href = "/passwordreset.html?email=" + encodeURIComponent(user_data.email)
        }).catch(error => {
            error.text().then(error_text => {
                register_result.value = {
                    message:  error_text,
                    is_error: true,
                    is_existing_user: error.status === 409 // Conflict
                }
            })
        })
    }

    watch(user_data, async (new_data, old_data) => {
        let val = user_data_val.value
        val.name = new_data.name ? null : "Name must not be empty"
        val.email = validateEmail(new_data.email) ? null : "Enter a valid email address"
        val.phone = validatePhone(new_data.phone) ? null : "Enter a valid phone number without space or parentheses (country code optional)"
        val.terms_agreed = new_data.terms_agreed ? null : "You must agree to the terms and conditions before registering"

        val.ready = val.name === null &&
            val.email === null &&
            val.phone === null &&
            val.terms_agreed === null
    })

    createApp({
        setup() {
            return {
                // Data
                user_data, user_data_val, register_result,
                // Callback functions
                onSubmit
            }
        }
    }).mount("#app")
</script>